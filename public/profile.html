<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æˆ‘çš„èµ„æ–™ - mkå¨æˆ¿</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Microsoft YaHei', Arial, sans-serif;
      background: #0a0e27;
      padding: 20px;
      color: #e4e9f7;
    }

    .container {
      max-width: 500px;
      margin: 20px auto;
      background: #1a2142;
      padding: 40px;
      border-radius: 12px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.4);
      border: 1px solid #2d3561;
    }

    h1 {
      color: #e4e9f7;
      margin-bottom: 30px;
      text-align: center;
      font-size: 28px;
    }

    .profile-section {
      margin-bottom: 25px;
    }

    .profile-section label {
      display: block;
      margin-bottom: 8px;
      color: #e4e9f7;
      font-weight: 600;
    }

    .profile-section input,
    .profile-section button {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #2d3561;
      border-radius: 8px;
      font-size: 14px;
    }

    .profile-section input {
      background: #151b3d;
      color: #e4e9f7;
      transition: all 0.3s;
    }

    .profile-section input:focus {
      outline: none;
      border-color: #00d4aa;
      box-shadow: 0 0 0 3px rgba(0,212,170,0.2);
    }

    .profile-info {
      background: #151b3d;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      border: 1px solid #2d3561;
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      padding-bottom: 10px;
      border-bottom: 1px solid #2d3561;
    }

    .info-row:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }

    .info-label {
      font-weight: 600;
      color: #a0aec0;
    }

    .info-value {
      color: #e4e9f7;
    }

    button {
      background: linear-gradient(135deg, #00d4aa, #00b894);
      color: #0a0e27;
      border: none;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
      box-shadow: 0 4px 15px rgba(0,212,170,0.3);
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0,212,170,0.4);
    }

    button:disabled {
      background: #2d3561;
      cursor: not-allowed;
      color: #a0aec0;
    }

    .error {
      color: #ff4757;
      margin-bottom: 15px;
      padding: 12px;
      background: rgba(255,71,87,0.2);
      border-radius: 8px;
      border: 1px solid #ff4757;
    }

    .success {
      color: #00d4aa;
      margin-bottom: 15px;
      padding: 12px;
      background: rgba(0,212,170,0.2);
      border-radius: 8px;
      border: 1px solid #00d4aa;
    }

    .button-group {
      display: flex;
      gap: 10px;
    }

    .button-group button {
      flex: 1;
    }

    .btn-secondary {
      background: #2d3561;
      color: #e4e9f7;
      box-shadow: none;
      border: 1px solid #2d3561;
    }

    .btn-secondary:hover {
      background: #3d4571;
    }

    .back-link {
      display: inline-block;
      margin-bottom: 20px;
      color: #00d4aa;
      text-decoration: none;
      font-weight: 600;
    }

    .back-link:hover {
      text-decoration: underline;
    }

    .edit-form {
      display: none;
    }

    .edit-form.active {
      display: block;
    }
  </style>
</head>
<body>
  <div class="container">
    <a href="/" class="back-link">â† è¿”å›é¦–é¡µ</a>

    <h1>ğŸ‘¤ æˆ‘çš„èµ„æ–™</h1>

    <div id="errorMsg" class="error" style="display:none;"></div>
    <div id="successMsg" class="success" style="display:none;"></div>

    <!-- æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯ -->
    <div id="profileView" class="profile-info">
      <div class="info-row">
        <span class="info-label">å§“åï¼š</span>
        <span class="info-value" id="displayName">-</span>
      </div>
      <div class="info-row">
        <span class="info-label">æ‰‹æœºï¼š</span>
        <span class="info-value" id="displayPhone">-</span>
      </div>
      <div class="info-row">
        <span class="info-label">èº«é«˜ï¼š</span>
        <span class="info-value" id="displayHeight">-</span>
      </div>
      <div class="info-row">
        <span class="info-label">ä½“é‡ï¼š</span>
        <span class="info-value" id="displayWeight">-</span>
      </div>
    </div>

    <button onclick="toggleEditForm()">âœï¸ ç¼–è¾‘èµ„æ–™</button>

    <!-- ç¼–è¾‘è¡¨å• -->
    <form id="editForm" class="edit-form">
      <div class="profile-section">
        <label>å§“å</label>
        <input type="text" id="editName" required>
      </div>

      <div class="profile-section">
        <label>èº«é«˜ (cm)</label>
        <input type="number" id="editHeight" min="0" step="0.1">
      </div>

      <div class="profile-section">
        <label>ä½“é‡ (kg)</label>
        <input type="number" id="editWeight" min="0" step="0.1">
      </div>

      <div class="button-group">
        <button type="submit">ğŸ’¾ ä¿å­˜</button>
        <button type="button" class="btn-secondary" onclick="toggleEditForm()">å–æ¶ˆ</button>
      </div>
    </form>
  </div>

  <script>
    let currentUser = null;

    // é¡µé¢åŠ è½½æ—¶è·å–ç”¨æˆ·ä¿¡æ¯
    window.addEventListener('load', loadProfile);

    async function loadProfile() {
      try {
        const token = localStorage.getItem('token');
        if (!token) {
          window.location.href = '/';
          return;
        }

        const response = await fetch('/api/auth/profile', {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        const data = await response.json();
        if (data.success) {
          currentUser = data.data;
          displayProfile(currentUser);
        } else {
          showError(data.message || 'è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥');
        }
      } catch (error) {
        console.error('è·å–ç”¨æˆ·ä¿¡æ¯é”™è¯¯:', error);
        showError('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥');
      }
    }

    function displayProfile(user) {
      document.getElementById('displayName').textContent = user.full_name || '-';
      document.getElementById('displayPhone').textContent = user.phone || '-';
      document.getElementById('displayHeight').textContent = user.height ? `${user.height} cm` : '-';
      document.getElementById('displayWeight').textContent = user.weight ? `${user.weight} kg` : '-';

      // å¡«å……ç¼–è¾‘è¡¨å•
      document.getElementById('editName').value = user.full_name || '';
      document.getElementById('editHeight').value = user.height || '';
      document.getElementById('editWeight').value = user.weight || '';
    }

    function toggleEditForm() {
      document.getElementById('editForm').classList.toggle('active');
      document.getElementById('profileView').classList.toggle('active');
    }

    // æäº¤ç¼–è¾‘è¡¨å•
    document.getElementById('editForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      try {
        const token = localStorage.getItem('token');
        const response = await fetch('/api/auth/profile', {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            full_name: document.getElementById('editName').value,
            height: parseFloat(document.getElementById('editHeight').value) || 0,
            weight: parseFloat(document.getElementById('editWeight').value) || 0
          })
        });

        const data = await response.json();
        if (data.success) {
          currentUser = data.data;
          displayProfile(currentUser);
          toggleEditForm();
          showSuccess('èµ„æ–™å·²æ›´æ–°');
        } else {
          showError(data.message || 'æ›´æ–°å¤±è´¥');
        }
      } catch (error) {
        console.error('æ›´æ–°é”™è¯¯:', error);
        showError('æ›´æ–°å¤±è´¥');
      }
    });

    function showError(msg) {
      const el = document.getElementById('errorMsg');
      el.textContent = msg;
      el.style.display = 'block';
      setTimeout(() => el.style.display = 'none', 3000);
    }

    function showSuccess(msg) {
      const el = document.getElementById('successMsg');
      el.textContent = msg;
      el.style.display = 'block';
      setTimeout(() => el.style.display = 'none', 3000);
    }
  </script>
</body>
</html>
